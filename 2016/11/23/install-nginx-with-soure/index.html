<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="blog of xuxiaoping"><title>nginx源码安装 | 许小平</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">nginx源码安装</h1><a id="logo" href="/.">许小平</a><p class="description">一点一滴积累</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">nginx源码安装</h1><div class="post-meta">Nov 23, 2016<span> | </span><span class="category"><a href="/categories/Nginx/">Nginx</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>以前装nginx都是用yum命令直接安装，一步到位。现在借着服务器迁移的机会，来次源码安装的实践。</p>
<h2 id="安装版本选择"><a href="#安装版本选择" class="headerlink" title="安装版本选择"></a>安装版本选择</h2><p>Nginx官网提供了三个类型的版本  </p>
<ul>
<li>Mainline version：Mainline 是 Nginx 目前主力在做的版本，可以说是开发版  </li>
<li>Stable version：最新稳定版，生产环境上建议使用的版本  </li>
<li>Legacy versions：遗留的老版本的稳定版</li>
</ul>
<p>我选择了nginx-1.10.2的稳定版本，下载到/usr/local/src的目录下</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># wget http://nginx.org//download/nginx-1.10.2.tar.gz  </span></div><div class="line"><span class="comment">//解压</span></div><div class="line"><span class="meta"># tar zxvf nginx-1.10.2.tar.gz</span></div></pre></td></tr></table></figure>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><ol>
<li><p>服务器环境</p>
 <figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># cat /etc/redhat-release </span></div><div class="line">CentOS Linux <span class="built_in">release</span> <span class="number">7.2</span><span class="number">.1511</span> (Core)</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>依赖包安装</p>
<p> nginx在编译和安装的时候需要一些工具和第三包模块，因此先下载安装</p>
 <figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># yum -y install gcc gcc-c++ make libtool zlib zlib-devel openssl openssl-devel pcre pcre-devel</span></div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li>编译配置项</li>
</ol>
<p>nginx大部分常用模块，编译时./configure –help以–without开头的都默认安装。</p>
<ul>
<li>–prefix=PATH ： 指定nginx的安装目录。默认 /usr/local/nginx  </li>
<li>–conf-path=PATH ： 设置nginx.conf配置文件的路径。nginx允许使用不同的配置文件启动，通过命令行中的-c选项。默认为prefix/conf/nginx.conf  </li>
<li>–user=name： 设置nginx工作进程的用户。安装完成后，可以随时在nginx.conf配置文件更改user指令。默认的用户名是nobody。–group=name类似  </li>
<li>–with-pcre ： 设置PCRE库的源码路径，如果已通过yum方式安装，使用–with-pcre自动找到库文件。使用–with-pcre=PATH时，需要从PCRE网站下载pcre库的源码（版本4.4 - 8.30）并解压，剩下的就交给Nginx的./configure和make来完成。perl正则表达式使用在location指令和 ngx_http_rewrite_module模块中。  </li>
<li>–with-zlib=PATH ： 指定 zlib（版本1.1.3 - 1.2.5）的源码解压目录。在默认就启用的网络传输压缩模块ngx_http_gzip_module时需要使用zlib 。  </li>
<li>–with-http_ssl_module ： 使用https协议模块。默认情况下，该模块没有被构建。前提是openssl与openssl-devel已安装  </li>
<li>–with-http_stub_status_module ： 用来监控 Nginx 的当前状态  </li>
<li>–with-http_realip_module ： 通过这个模块允许我们改变客户端请求头中客户端IP地址值(例如X-Real-IP 或 X-Forwarded-For)，意义在于能够使得后台服务器记录原始客户端的IP地址  </li>
<li>–add-module=PATH ： 添加第三方外部模块，如nginx-sticky-module-ng或缓存模块。每次添加新的模块都要重新编译（Tengine可以在新加入module时无需重新编译） </li>
</ul>
<p>第一次尝试在服务器上编译，就简单的安装配置  </p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">./configure </div><div class="line">		-<span class="ruby">-user=nginx\</span></div><div class="line">		-<span class="ruby">-group=nginx\</span></div><div class="line">		-<span class="ruby">-with-http_ssl_module\</span></div><div class="line">		-<span class="ruby">-with-http_gzip_static_module\</span></div><div class="line">		-<span class="ruby">-with-http_realip_module\</span></div><div class="line">		-<span class="ruby">-with-http_stub_status_module</span></div></pre></td></tr></table></figure>
<p>安装和编译，安装成功的标准就是不报错</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">make</span> &amp;&amp; <span class="built_in">make</span> install</div></pre></td></tr></table></figure>
<p>完成之后，启动nginx服务器</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.<span class="regexp">/usr/</span>local<span class="regexp">/nginx/</span>sbin<span class="regexp">/nginx</span></div></pre></td></tr></table></figure>
<p>至此nginx安装完毕。下面进行一下优化阶段</p>
<h2 id="nginx设置"><a href="#nginx设置" class="headerlink" title="nginx设置"></a>nginx设置</h2><ol>
<li><p>设置成系统服务，不用每次都使用<code>./usr/local/nginx/sbin/nginx</code> ,来进行操作  </p>
<blockquote>
<p>服务有系统（system）和用户（user）之分。如果需要开机没有登录情况下就能运行的程序，存在于系统服务（system）里，即：<code>/lib/systemed/system</code><br>反之，用户登录后才能运行的程序，存在于用户服务（user)里:<code>/lib/systemd/user</code><br>并且服务都以.service结尾</p>
</blockquote>
<p> 因此，在<code>/lib/systemed/system</code>下建立一个nginx.service的文件,添加</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="section">[Unit]</span></div><div class="line"><span class="attr">Description</span>=nginx.service</div><div class="line"><span class="attr">After</span>=network.target</div><div class="line"><span class="section"></span></div><div class="line">[Service]</div><div class="line"><span class="attr">Type</span>=forking</div><div class="line"><span class="attr">ExecStart</span>=/usr/local/nginx/sbin/nginx</div><div class="line"><span class="attr">ExecReload</span>=/usr/local/nginx/sbin/nginx -s reload</div><div class="line"><span class="attr">ExecStop</span>=/usr/local/nginx/sbin/nginx -s stop</div><div class="line"><span class="attr">PrivateTmp</span>=<span class="literal">true</span></div><div class="line"><span class="section"></span></div><div class="line">[Install]</div><div class="line"><span class="attr">WantedBy</span>=multi-user.target</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>然后将文件的权限修改为754，只有root用户才能修改。

<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">chmod</span> 754 <span class="selector-tag">nginx</span><span class="selector-class">.service</span></div></pre></td></tr></table></figure>


将nginx设置为系统服务，并开机启动

<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl <span class="built_in">enable</span> nginx.service</div></pre></td></tr></table></figure>

当然也可以使用systemctl来管理nginx的启动和关闭了

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">启动：systemctl start nginx<span class="selector-class">.service</span></div><div class="line">关闭：systemctl stop nginx<span class="selector-class">.service</span></div><div class="line">状态：systemctl status nginx.service</div></pre></td></tr></table></figure>

对于喜欢用systemctl的我，感觉就是棒棒的  

将 nginx 作为系统服务管理,下载 [nginx](http://sean-images.qiniudn.com/nginx) 到/etc/init.d/，修改里面的路径然后赋予可执行权限

<figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># service nginx &#123;start|<span class="type">stop</span>|<span class="type">status</span>|<span class="type">restart</span>|<span class="type">reload</span>|<span class="type">configtest</span>&#125;</div></pre></td></tr></table></figure>
</code></pre><h2 id="nginx常用命令"><a href="#nginx常用命令" class="headerlink" title="nginx常用命令"></a>nginx常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">nginx <span class="_">-s</span> reload 重启</div><div class="line">nginx -t 测试配置文件</div><div class="line">nginx <span class="_">-s</span> stop 关闭nginx</div><div class="line">nginx -v nginx 版本</div><div class="line">nginx -V nginx编译时的配置项</div></pre></td></tr></table></figure>
<h2 id="安装时的错误汇总"><a href="#安装时的错误汇总" class="headerlink" title="安装时的错误汇总"></a>安装时的错误汇总</h2><ol>
<li><p>测试nginx的配置文件出现错误</p>
 <figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nginx: <span class="string">[emerg]</span> getpwnam(<span class="string">"nginx"</span>) failed</div></pre></td></tr></table></figure>
<p> 原因是在安装配置时指定了user=nginx和group=nginx,而现在系统中并没有这个用户组和用户，因此需要先创建对应的组和用户</p>
 <figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">groupadd nginx </span></div><div class="line">useradd -g nginx nginx</div></pre></td></tr></table></figure>
<p> 之后测试就通过了。</p>
</li>
</ol>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://xuxping.github.io/2016/11/23/install-nginx-with-soure/" data-id="ciwkakncy00044c9khncap0jg" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Nginx/">Nginx</a></div><div class="post-nav"><a href="/2016/12/05/lnmp-installmd/" class="pre">LNMP环境搭建</a><a href="/2016/11/23/front-module-go/" class="next">模块系统演化</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://xuxping.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP总结/">PHP总结</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/个人思考/">个人思考</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/大前端/">大前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器/">服务器</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/tools/" style="font-size: 15px;">tools</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/laravel/" style="font-size: 15px;">laravel</a> <a href="/tags/服务器/" style="font-size: 15px;">服务器</a> <a href="/tags/sass/" style="font-size: 15px;">sass</a> <a href="/tags/个人思考/" style="font-size: 15px;">个人思考</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/12/11/js对象的拷贝问题/">js对象的拷贝问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/05/lnmp-installmd/">LNMP环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/23/install-nginx-with-soure/">nginx源码安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/23/front-module-go/">模块系统演化</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/15/laravel-use-vue/">laravel5.2结合vue开发</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/11/php课程总结/">PHP提升课程总结目录</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/20/summary-of-SASS/">SASS使用总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/01/个人php技术达标指标/">个人技术栈汇总和期望</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/28/nginx配置虚拟多站点/">nginx配置虚拟多站点</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/28/firewall使用总结/">firewalld使用总结</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">许小平.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>